#!/usr/bin/env bash
set -euo pipefail

MUTED='\033[0;2m'
RED='\033[0;31m'
ORANGE='\033[38;5;214m'
GREEN='\033[0;32m'
NC='\033[0m'

usage() {
    cat <<EOF
Kilo CLI ARM64 Installer

Usage: install [options]

Options:
    -h, --help              Display this help message
    -v, --version <version> Install a specific version
    --musl                  Install musl variant (for Alpine Linux)
    --no-modify-path        Don't modify shell config files

Examples:
    curl -fsSL https://raw.githubusercontent.com/JohnDSdev/kilo-arm/main/install | bash
    curl -fsSL https://raw.githubusercontent.com/JohnDSdev/kilo-arm/main/install | bash -s -- --musl
EOF
}

requested_version=${VERSION:-}
no_modify_path=false
use_musl=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            if [[ -n "${2:-}" ]]; then
                requested_version="$2"
                shift 2
            else
                echo -e "${RED}Error: --version requires a version argument${NC}"
                exit 1
            fi
            ;;
        --musl)
            use_musl=true
            shift
            ;;
        --no-modify-path)
            no_modify_path=true
            shift
            ;;
        *)
            echo -e "${ORANGE}Warning: Unknown option '$1'${NC}" >&2
            shift
            ;;
    esac
done

INSTALL_DIR=$HOME/.kilo/bin
mkdir -p "$INSTALL_DIR"

raw_os=$(uname -s)
os=$(echo "$raw_os" | tr '[:upper:]' '[:lower:]')

if [[ "$os" != "linux" ]]; then
    echo -e "${RED}Error: This installer is for Linux only.${NC}"
    echo -e "${MUTED}For macOS or Windows, use the official installer:${NC}"
    echo -e "${MUTED}  curl -fsSL https://kilo.ai/cli/install | bash${NC}"
    exit 1
fi

arch=$(uname -m)
if [[ "$arch" != "aarch64" && "$arch" != "arm64" ]]; then
    echo -e "${RED}Error: This installer is for ARM64 systems only.${NC}"
    echo -e "${MUTED}Detected architecture: $arch${NC}"
    echo -e "${MUTED}For x86_64 systems, use the official installer:${NC}"
    echo -e "${MUTED}  curl -fsSL https://kilo.ai/cli/install | bash${NC}"
    exit 1
fi

is_musl=false
if [ -f /etc/alpine-release ]; then
    is_musl=true
fi

if command -v ldd >/dev/null 2>&1; then
    if ldd --version 2>&1 | grep -qi musl; then
        is_musl=true
    fi
fi

if [ "$use_musl" = true ] && [ "$is_musl" = false ]; then
    echo -e "${ORANGE}Note: --musl specified but system appears to use glibc${NC}"
    is_musl=true
fi

if [ "$is_musl" = true ]; then
    variant="musl"
else
    variant="glibc"
fi

filename="kilo-linux-arm64"
if [ "$is_musl" = true ]; then
    filename="kilo-linux-arm64-musl"
fi
filename="${filename}.tar.gz"

if [ -z "$requested_version" ]; then
    url="https://github.com/JohnDSdev/kilo-arm/releases/latest/download/${filename}"
else
    requested_version="${requested_version#v}"
    url="https://github.com/JohnDSdev/kilo-arm/releases/download/v${requested_version}/${filename}"
fi

print_message() {
    local level=$1
    local message=$2
    local color=""

    case $level in
        info) color="${NC}" ;;
        warning) color="${ORANGE}" ;;
        error) color="${RED}" ;;
        success) color="${GREEN}" ;;
    esac

    echo -e "${color}${message}${NC}"
}

download_and_install() {
    print_message info "\n${MUTED}Installing ${NC}Kilo CLI ${MUTED}for ARM64 (${variant})${NC}"
    
    local tmp_dir="${TMPDIR:-/tmp}/kilo_install_$$"
    mkdir -p "$tmp_dir"

    print_message info "${MUTED}Downloading from:${NC} $url"
    
    if ! curl -fsSL -o "$tmp_dir/$filename" "$url"; then
        echo -e "${RED}Error: Failed to download binary${NC}"
        echo -e "${MUTED}URL: $url${NC}"
        rm -rf "$tmp_dir"
        exit 1
    fi

    tar -xzf "$tmp_dir/$filename" -C "$tmp_dir"

    mv "$tmp_dir/kilo" "$INSTALL_DIR"
    chmod 755 "${INSTALL_DIR}/kilo"
    rm -rf "$tmp_dir"
}

download_and_install

add_to_path() {
    local config_file=$1
    local command=$2

    if grep -Fxq "$command" "$config_file"; then
        print_message info "Command already exists in $config_file, skipping write."
    elif [[ -w $config_file ]]; then
        echo -e "\n# kilo" >> "$config_file"
        echo "$command" >> "$config_file"
        print_message info "${MUTED}Successfully added ${NC}kilo ${MUTED}to \$PATH in ${NC}$config_file"
    else
        print_message warning "Manually add the directory to $config_file (or similar):"
        print_message info "  $command"
    fi
}

XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}

if [[ "$no_modify_path" != "true" ]]; then
    current_shell=$(basename "$SHELL")
    case $current_shell in
        fish)
            config_files="$HOME/.config/fish/config.fish"
            ;;
        zsh)
            config_files="${ZDOTDIR:-$HOME}/.zshrc ${ZDOTDIR:-$HOME}/.zshenv $XDG_CONFIG_HOME/zsh/.zshrc $XDG_CONFIG_HOME/zsh/.zshenv"
            ;;
        bash)
            config_files="$HOME/.bashrc $HOME/.bash_profile $HOME/.profile $XDG_CONFIG_HOME/bash/.bashrc $XDG_CONFIG_HOME/bash/.bash_profile"
            ;;
        ash)
            config_files="$HOME/.ashrc $HOME/.profile /etc/profile"
            ;;
        sh)
            config_files="$HOME/.ashrc $HOME/.profile /etc/profile"
            ;;
        *)
            config_files="$HOME/.bashrc $HOME/.bash_profile $XDG_CONFIG_HOME/bash/.bashrc $XDG_CONFIG_HOME/bash/.bash_profile"
            ;;
    esac

    config_file=""
    for file in $config_files; do
        if [[ -f $file ]]; then
            config_file=$file
            break
        fi
    done

    if [[ -z $config_file ]]; then
        print_message warning "No config file found for $current_shell. You may need to manually add to PATH:"
        print_message info "  export PATH=$INSTALL_DIR:\$PATH"
    elif [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
        case $current_shell in
            fish)
                add_to_path "$config_file" "fish_add_path $INSTALL_DIR"
                ;;
            *)
                add_to_path "$config_file" "export PATH=$INSTALL_DIR:\$PATH"
                ;;
        esac
    fi
fi

if [ -n "${GITHUB_ACTIONS-}" ] && [ "${GITHUB_ACTIONS}" == "true" ]; then
    echo "$INSTALL_DIR" >> $GITHUB_PATH
    print_message info "Added $INSTALL_DIR to \$GITHUB_PATH"
fi

echo -e ""
echo -e "${GREEN}Installation complete!${NC}"
echo -e ""
echo -e "${MUTED}Kilo includes free models so you can start immediately:${NC}"
echo -e ""
echo -e "cd <project>  ${MUTED}# Open directory${NC}"
echo -e "kilo          ${MUTED}# Run Kilo${NC}"
echo -e ""
echo -e "${MUTED}For more information visit ${NC}https://kilo.ai/docs"
echo -e ""
