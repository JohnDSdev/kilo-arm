#!/bin/bash
# Install Kilo CLI on ARMv8.0 CPUs (Cortex-A53, Rock 2A, Raspberry Pi 4, etc.)
# This script runs Kilo from source to avoid compiled binary compatibility issues

set -e

MUTED='\033[0;2m'
RED='\033[0;31m'
GREEN='\033[0;32m'
ORANGE='\033[38;5;214m'
NC='\033[0m'

echo -e "${GREEN}=== Kilo CLI Installer for ARMv8.0 ===${NC}"
echo ""

INSTALL_DIR="$HOME/.kilo"
SOURCE_DIR="$INSTALL_DIR/source"
BIN_DIR="$INSTALL_DIR/bin"

# Install system dependencies
echo -e "${MUTED}Installing system dependencies...${NC}"
if command -v apt-get &> /dev/null; then
    sudo apt-get update -qq
    sudo apt-get install -y -qq unzip git curl python3 make g++ > /dev/null
fi

# Check for compatible runtime
RUNTIME=""

# Check Bun first
if [ -f "$HOME/.bun/bin/bun" ]; then
    export PATH="$HOME/.bun/bin:$PATH"
fi

if command -v bun &> /dev/null; then
    echo -e "${MUTED}Testing Bun compatibility...${NC}"
    if bun -e "console.log('ok')" 2>/dev/null; then
        echo -e "${GREEN}✓ Bun is compatible!${NC}"
        RUNTIME="bun"
    else
        echo -e "${ORANGE}✗ Bun not compatible with this CPU (ARMv8.0)${NC}"
    fi
fi

# Fall back to Node.js
if [ -z "$RUNTIME" ]; then
    echo -e "${MUTED}Checking Node.js...${NC}"
    if ! command -v node &> /dev/null; then
        echo -e "${MUTED}Installing Node.js 20...${NC}"
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - > /dev/null 2>&1
        sudo apt-get install -y -qq nodejs > /dev/null
    fi
    
    if node -e "console.log('ok')" 2>/dev/null; then
        echo -e "${GREEN}✓ Node.js is compatible!${NC}"
        RUNTIME="node"
    else
        echo -e "${RED}ERROR: No compatible JavaScript runtime found${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}Using runtime: $RUNTIME${NC}"
echo ""

# Create directories
mkdir -p "$INSTALL_DIR"
mkdir -p "$BIN_DIR"

# Clone or update source
if [ -d "$SOURCE_DIR" ]; then
    echo -e "${MUTED}Updating Kilo source...${NC}"
    cd "$SOURCE_DIR"
    git pull -q 2>/dev/null || git fetch -q && git reset --hard origin/dev -q
else
    echo -e "${MUTED}Cloning Kilo repository (this may take a minute)...${NC}"
    git clone --depth 1 --branch dev --single-branch https://github.com/Kilo-Org/kilo.git "$SOURCE_DIR" 2>/dev/null
    cd "$SOURCE_DIR"
fi

# Install dependencies
echo -e "${MUTED}Installing dependencies (this may take a few minutes)...${NC}"
if [ "$RUNTIME" = "bun" ]; then
    bun install --silent 2>/dev/null
else
    npm install --silent 2>/dev/null
fi

# Create wrapper script
cat > "$BIN_DIR/kilo" << WRAPPER
#!/bin/bash
export PATH="$HOME/.bun/bin:\$PATH"
cd "$SOURCE_DIR/packages/opencode"
if command -v bun &> /dev/null && bun -e "1" 2>/dev/null; then
    exec bun run --conditions=browser ./src/index.ts "\$@"
else
    exec npx tsx ./src/index.ts "\$@"
fi
WRAPPER

chmod +x "$BIN_DIR/kilo"

# Create kilocode symlink
ln -sf "$BIN_DIR/kilo" "$BIN_DIR/kilocode" 2>/dev/null || true

# Add to PATH
current_shell=$(basename "$SHELL")
config_file=""

case $current_shell in
    bash) config_file="$HOME/.bashrc" ;;
    zsh) config_file="${ZDOTDIR:-$HOME}/.zshrc" ;;
    fish) config_file="$HOME/.config/fish/config.fish" ;;
esac

if [ -n "$config_file" ] && [ -f "$config_file" ]; then
    if ! grep -q "export PATH=\"\$HOME/.kilo/bin:\$PATH\"" "$config_file" 2>/dev/null; then
        echo "" >> "$config_file"
        echo "# Kilo CLI" >> "$config_file"
        echo "export PATH=\"\$HOME/.kilo/bin:\$PATH\"" >> "$config_file"
    fi
fi

# Export PATH for current session
export PATH="$BIN_DIR:$PATH"

echo ""
echo -e "${GREEN}=== Installation Complete ===${NC}"
echo ""
echo -e "${MUTED}Kilo installed to: ${NC}$BIN_DIR/kilo"
echo -e "${MUTED}Runtime: ${NC}$RUNTIME"
echo ""
echo -e "${GREEN}Run 'kilo' to start!${NC}"
echo ""
echo -e "${MUTED}First time? Start a new shell or run:${NC}"
echo -e "  source ~/$current_shell"
echo ""
